{%- macro to_yaml(item) -%}
{%- for key, value in item.items() -%}
{%- if value is mapping %}
{{ key }}:
{%- filter indent(width=2) -%}
{{ to_yaml(value) }}
{%- endfilter %}
{%- else %}
{{ key }}: {{value}}
{%- endif -%}
{%- endfor -%}
{%- endmacro -%}
global:
  argocd:
    destination:
      name: in-cluster
      server: ''
  {%- if global is defined -%}
  {%- filter indent(width=2) -%}
  {{ to_yaml(global)}}
  {%- endfilter %}
  {%- endif %}
applications:
  helm:
  {%- for key2, app in helm.items() %}
    - name: {{key2}}
      {%- if app.path is defined %}
      path: {{app.path}}
      {%- endif %}
      {%- if app.chartRevision is defined %}
      chartRevision: {{app.chartRevision}}
      {%- endif %}
      chart: {{app.chart}}
      {%- if app.valueFiles is defined %}
      values:
      {%- for valueFile in app.valueFiles %}
        {% filter indent(width=8) %}
        {%- include "environment/"+global.namespace+'/'+app.path+'/'+valueFile %}
        {%- endfilter %}
      {%- endfor %}
      {%- endif %}
      test: 1
  {%- endfor %}
